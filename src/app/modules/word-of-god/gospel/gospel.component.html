<!-- Gospel Readings Card -->
<div class="bg-white/90 rounded-xl card-shadow p-4 md:p-6 mb-8 border border-purple-200">

  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
    <h3 class="text-lg md:text-xl font-semibold text-gray-800">Gospel Readings</h3>

    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
      <!-- Year Filter -->
      <select
        [(ngModel)]="selectedYear"
        (change)="applyFilters()"
        class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md
               focus:outline-none focus:ring-2 focus:ring-purple-600"
      >
        <option [ngValue]="null">All Years</option>
        <option *ngFor="let y of [2023, 2024, 2025]" [ngValue]="y">{{ y }}</option>
      </select>

      <!-- Month Filter -->
      <select
        [(ngModel)]="selectedMonth"
        (change)="applyFilters()"
        class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md
               focus:outline-none focus:ring-2 focus:ring-purple-600"
      >
        <option [ngValue]="null">All Months</option>
        <option *ngFor="let m of months" [ngValue]="m.value">{{ m.name }}</option>
      </select>

      <!-- Add Gospel Button (Admin only) -->
      <button
        *ngIf="isAdmin"
        (click)="addGospel()"
        class="px-3 py-2 rounded-md bg-purple-600 text-white hover:bg-purple-700 transition font-semibold"
      >
        ‚ûï Add Reading
      </button>
    </div>
  </div>

  <!-- ‚úÖ Gospel List (INTERNAL SCROLL + FADE + KEYBOARD) -->
  <div
    #gospelScroll
    class="gospel-scrollbox"
    [class.at-top]="scrollAtTop"
    [class.at-bottom]="scrollAtBottom"
    [style.maxHeight.px]="scrollMaxHeight"
    tabindex="0"
    (scroll)="onScroll()"
    (keydown)="onScrollKey($event)"
  >
    <div class="space-y-4">
      <div
        #gospelItem
        *ngFor="let g of filteredGospels"
        class="p-4 border border-purple-100 rounded-lg shadow-sm hover:bg-purple-50/40 cursor-pointer transition"
        (click)="openViewGospel(g)"
      >
        <div class="flex justify-between items-start mb-3 gap-3">
          <div>
            <h4 class="font-semibold text-gray-800">{{ g.title }}</h4>
            <p class="text-sm text-gray-500">{{ g.date | date: 'MMMM d, y' }}</p>
          </div>

          <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2.5 py-1 rounded-full">
            {{ g.reading }}
          </span>
        </div>

        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg mb-3">
          <div class="text-gray-700 text-sm leading-relaxed italic">
            "{{ getShortContent(g.content) }}"
          </div>
        </div>

        <div class="flex gap-2" *ngIf="isAdmin">
          <button
            (click)="editGospel(g.id); $event.stopPropagation()"
            class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-200 text-sm font-semibold"
          >
            ‚úèÔ∏è Edit
          </button>

          <button
            (click)="deleteGospel(g.id); $event.stopPropagation()"
            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200 text-sm font-semibold"
          >
            üóëÔ∏è Delete
          </button>
        </div>
      </div>

      <div *ngIf="filteredGospels.length === 0" class="text-gray-500 italic">
        No gospel readings found for this filter.
      </div>
    </div>
  </div>
</div>

<!-- FORM / REVIEW MODAL -->
<div *ngIf="showModal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-xl border border-purple-100">
    <!-- Header -->
    <div class="px-5 py-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-bold">{{ modalTitle }}</h3>
      <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700 text-xl leading-none">
        √ó
      </button>
    </div>

    <!-- EDIT FORM (step 1) -->
    <form *ngIf="!isReviewing" [formGroup]="modalForm" class="p-5 space-y-4">
      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Title</label>
        <input
          type="text"
          formControlName="title"
          class="mt-1 w-full rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600"
        />
        <div *ngIf="modalForm.get('title')?.touched && modalForm.get('title')?.invalid" class="text-red-500 text-sm">
          Title is required
        </div>
      </div>

      <!-- Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Date</label>
        <input
          type="date"
          formControlName="date"
          class="mt-1 w-full rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600"
        />
        <div *ngIf="modalForm.get('date')?.touched && modalForm.get('date')?.invalid" class="text-red-500 text-sm">
          Date is required
        </div>
      </div>

      <!-- Gospel Reading -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Gospel Reading</label>
        <input
          type="text"
          formControlName="reading"
          placeholder="e.g., John 3:16"
          class="mt-1 w-full rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600"
        />
        <div *ngIf="modalForm.get('reading')?.touched && modalForm.get('reading')?.invalid" class="text-red-500 text-sm">
          Reading is required
        </div>
      </div>

      <!-- Content -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Content</label>
        <textarea
          formControlName="content"
          rows="6"
          class="mt-1 w-full rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600"
        ></textarea>
        <div *ngIf="modalForm.get('content')?.touched && modalForm.get('content')?.invalid" class="text-red-500 text-sm">
          Content is required
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 pt-2">
        <button
          type="button"
          (click)="startReview()"
          class="flex-1 bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 font-semibold"
        >
          Review Before Saving
        </button>

        <button
          type="button"
          (click)="closeModal()"
          class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-md hover:bg-gray-200 font-semibold"
        >
          Cancel
        </button>
      </div>
    </form>

    <!-- REVIEW STEP (step 2) -->
    <div *ngIf="isReviewing" class="p-5 space-y-4">
      <h4 class="text-md font-semibold text-gray-800 mb-2">Please review this gospel before saving:</h4>

      <div class="bg-gray-50 border rounded-lg p-4 space-y-2">
        <div>
          <span class="text-xs font-semibold text-gray-500 uppercase">Title</span>
          <p class="text-sm text-gray-800">{{ reviewData?.title }}</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <span class="text-xs font-semibold text-gray-500 uppercase">Date</span>
            <p class="text-sm text-gray-800">{{ reviewData?.date }}</p>
          </div>
          <div>
            <span class="text-xs font-semibold text-gray-500 uppercase">Reading</span>
            <p class="text-sm text-gray-800">{{ reviewData?.reading }}</p>
          </div>
        </div>

        <div>
          <span class="text-xs font-semibold text-gray-500 uppercase">Content</span>
          <div class="mt-1 text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
            {{ reviewData?.content }}
          </div>
        </div>
      </div>

      <p class="text-xs text-gray-500 mt-1">
        If everything looks correct, click <span class="font-semibold">Confirm &amp; Save</span>. Otherwise, go back and edit.
      </p>

      <div class="flex gap-3 pt-2">
        <button
          type="button"
          (click)="backToEdit()"
          class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-md hover:bg-gray-200 font-semibold"
        >
          Back to Edit
        </button>

        <button
          type="button"
          (click)="confirmAndSave()"
          class="flex-1 bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 font-semibold"
        >
          Confirm &amp; Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- VIEW-ONLY GOSPEL MODAL (when clicking a card) -->
<div *ngIf="showViewModal && viewGospelItem" class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-xl rounded-xl shadow-xl border border-purple-100">
    <div class="px-5 py-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-bold">{{ viewGospelItem.title }}</h3>
      <button (click)="closeViewModal()" class="text-gray-500 hover:text-gray-700 text-xl leading-none">
        √ó
      </button>
    </div>

    <div class="p-5 space-y-3">
      <p class="text-sm text-gray-500">
        {{ viewGospelItem.date | date: 'MMMM d, y' }}
      </p>

      <p class="text-sm font-medium text-purple-700" *ngIf="viewGospelItem.reading">
        {{ viewGospelItem.reading }}
      </p>

      <div class="mt-2 text-gray-800 text-sm whitespace-pre-wrap leading-relaxed bg-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg">
        {{ viewGospelItem.content }}
      </div>

      <div class="flex justify-end pt-2">
        <button
          class="px-4 py-2 rounded-md bg-purple-600 text-white hover:bg-purple-700 text-sm font-semibold"
          (click)="closeViewModal()"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
